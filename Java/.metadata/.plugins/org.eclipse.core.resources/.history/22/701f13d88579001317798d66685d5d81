package pl.edu.agh.monitordb.test;

import static org.junit.Assert.*;

import org.junit.Before;
import org.junit.Test;
import org.junit.runners.model.FrameworkMethod;

import org.hibernate.HibernateException;
import org.hibernate.Transaction;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.cfg.Configuration;
import org.hibernate.service.*;
import org.hibernate.Criteria;
import org.hibernate.criterion.Restrictions;
import org.hibernate.hql.internal.ast.HqlSqlWalker;
import org.hibernate.hql.internal.ast.tree.Statement;

public class SessionFactoryRule {
	 private SessionFactory sessionFactory;
	 private Transaction transaction;
	 private Session session;
	 
	 
	 public Statement apply(final Statement statement, FrameworkMethod method, Object test) {
	  return new Statement() {
	 
	   public void evaluate() throws Throwable {
	    sessionFactory = createSessionFactory();
	    createSession();
	    beginTransaction();
	    try {
	     statement.evaluate();
	    } finally {
	     shutdown();
	    }
	   }

	@Override
	public int getStatementType() {
		// TODO Auto-generated method stub
		return 0;
	}

	@Override
	public HqlSqlWalker getWalker() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public boolean needsExecutor() {
		// TODO Auto-generated method stub
		return false;
	}
	 
	  };
	 }
	 
	 private void shutdown() {
	  try {
	   try {
	    try {
	     transaction.rollback();
	    } catch (Exception ex) {
	     ex.printStackTrace();
	    }
	    session.close();
	   } catch (Exception ex) {
	    ex.printStackTrace();
	   }
	   sessionFactory.close();
	  } catch (Exception ex) {
	   ex.printStackTrace();
	  }
	 }
	 
	 private SessionFactory createSessionFactory() {
		Configuration configuration = new Configuration().configure();
		ServiceRegistry serviceRegistry = (ServiceRegistry) new ServiceRegistryBuilder().applySettings(configuration.getProperties()).buildServiceRegistry();
		sessionFactory = configuration.buildSessionFactory(serviceRegistry);
		return sessionFactory;
	 }
	 
	 public Session createSession() {
	  session = sessionFactory.openSession();
	  return session;
	 }
	 
	 public void commit() {
	  transaction.commit();
	 }
	 
	 public void beginTransaction() {
	  transaction = session.beginTransaction();
	 }
	 
	 public Session getSession() {
	  return session;
	 }
	}


